#!/bin/bash
set -u -e -C
shopt -s nullglob

function err { echo $'\e[1;31m'"$@"$'\e[m' >&2; exit 1; }
function warn { echo $'\e[1;35m'"$@"$'\e[m' >&2; }
function info { echo $'\n\e[36m'"$@"$'\e[m'; }

function ask_yN {
    local answer=''
    read -n 1 -s -p $'\e[34m'"$* [yN]"$'\e[m' answer
    if test "${answer}" = y; then
        info yes
        return 0
    fi
    info no
    return 1
}

function listBlockDevices {
    info 'List block devices'
    lsblk -oname,size,type,mountpoint
}


if test "${1-}" = '-u'; then
    shift

    listBlockDevices

    info 'Close open LUKS device'

    map=''
    mnt="${1-}"
    if test "${mnt}"; then
        mnt="$(realpath "${mnt}")"
        if mountpoint "${mnt}"; then
            while IFS= read -r map; do
                map="${map#/dev/mapper/}"
                echo "Is mapped to ${map}"
                break
            done < <(sed -En 's#^(\S+)\s+'"${mnt}"'\s.*#\1#p' < /proc/mounts)
        else
            err "Not a mountpoint: ${mnt}"
        fi
    fi

    until
        test -h "/dev/mapper/${map}"
    do
        dmsetup ls --target crypt
        read -e -i "${map-}" -p 'close = ' map
        map="${map#/dev/mapper/}"
    done
    if test "${map}"; then
        umount "/dev/mapper/${map}" || warn "Failed: umount /dev/mapper/${map}"
        cryptsetup close "$map" || warn "Failed: cryptsetup close ${map}"
        listBlockDevices
    else
        err "Does not exist: ${map}"
    fi

elif test "${1-}" = '-m'; then
    shift

    listBlockDevices

    info 'Open new LUKS device'

    dev="${1-}"
    until
        if test -z "${dev}"; then
            false
        else
            if cryptsetup isLuks "${dev}"; then
                true
            else
                warn "Not a LUKS device: $dev"
                false
            fi
        fi
    do
        read -e -i "${dev-}" -p 'device = ' dev
        test -z "${dev}" && exit
    done

    mnt="${2-}"
    until
        test -d "${mnt}"
    do
        read -e -i "${mnt-}" -p 'mountpoint = ' mnt
        if test -z "${mnt}"; then
            mnt="$(mktemp -t -d mnt.XXXXXXXXXXXXXXX)"
            warn "Created new ${mnt}"
        fi
    done

    map="$(blkid -ovalue -sUUID "${dev}")"

    keyfile="${3-}"
    until
        if test -z "${keyfile}"; then
            false
        elif test "${keyfile}" = -; then
            cryptsetup open "${dev}" "${map}" --type luks
        elif test -r "${keyfile}"; then
            cryptsetup open "${dev}" "${map}" --type luks \
                       --key-file "${keyfile}"
        else
            warn 'Pass keyfile or `-` for passphrase'
            false
        fi
    do
        read -e -i "${keyfile-}" -p 'keyfile = ' keyfile
    done || err 'Nothing opened'

    if mount "/dev/mapper/${map}" "${mnt}"; then
        info "Success."
    else
        cryptsetup close "$map" || warn 'Failed: cryptsetup close'
        err 'Failed: mount'
    fi

    listBlockDevices

else

    cat <<'.'
Synopsis

    luks -m [device [mountpoint [keyfile | -]]]

    luks -u

.
fi
